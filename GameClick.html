<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Game Click</title>
    <style>
        #score {
            text-align: center;
            font-size: 30px;
        }
    </style>
</head>

<body onload="startGame()">
    <p id="score">Score: </p>
    <script type="text/javascript">
        var targets = [];
        var distance = 0;
        var shotTargets = [];
        var score = 0;

        function startGame() {
            gameArea.start();
        }

        function targetGone() {
            for (let i = 0; i < targets.length; i++)
                if (targets[i].y > 400) return true;
        }

        function clickHandler() {
            x = event.clientX - gameArea.canvas.offsetLeft;
            y = event.clientY - gameArea.canvas.offsetTop;
            checkTarget(x, y);
        }

        function checkTarget() {
            for (let i = 0; i < targets.length; i++) {
                if (x >= targets[i].x && x <= targets[i].x + 20 && y >= targets[i].y && y <= targets[i].y + 20) {
                    targets[i].shot = true;
                    shotTargets.push(targets[i]);
                    targets.splice(i, 1);
                    score++;
                }
            }
        }

        var gameArea = {
            canvas: document.createElement("canvas"),
            start: function() {
                this.canvas.width = 300;
                this.canvas.height = 400;
                this.canvas.style.background = "yellow";
                this.canvas.style.border = "3px solid gray";
                this.canvas.style.margin = "auto";
                this.canvas.style.display = "block";
                document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                this.context = this.canvas.getContext("2d");
                this.canvas.addEventListener("click", clickHandler, event);
                requestAnimationFrame(gameArea.update);
                gameArea.update()
            },
            update: function() {
                gameArea.context.clearRect(0, 0, 300, 400);
                document.getElementById("score").innerText = "score:" + score;
                if (score == 10) {
                    gameArea.stop(true);
                    return;
                }
                if (targetGone()) {
                    gameArea.stop(false);
                    return;
                }
                if (targets.length == 0 || targets[targets.length - 1].y >= distance) {
                    var t = new target();
                    targets.push(t);
                    distance = Math.floor(Math.random() * 120);
                }
                for (let i = 0; i < targets.length; i++) targets[i].draw();
                if (shotTargets.length > 0) {
                    for (let i = 0; i < shotTargets.length; i++) shotTargets[i].draw();
                    for (let j = 0; j < shotTargets.length; j++)
                        if (shotTargets[j].shotCount == 16) shotTargets.splice(j, 1);

                }
                requestAnimationFrame(gameArea.update);
            },
            stop: function(win) {
                gameArea.canvas.removeEventListener("ckick", clickHandler, event);
                gameArea.context.fillStyle = "grey";
                gameArea.context.globalAlpha = 0.5;
                gameArea.context.fillRect(0, 0, 300, 400);
                gameArea.context.globalAlpha = 1.0;
                gameArea.context.fillRect(0, 100, 300, 100);
                gameArea.context.font = "20px Comic Sans MS";
                if (win) {
                    gameArea.context.fillStyle = "LawnGreen";
                    gameArea.context.fillText("Bạn đã thắng", 40, 150);
                } else {
                    gameArea.context.fillStyle = "red";
                    gameArea.context.fillText(" Thua rồi ! làm lại nào ^^  " + score, 40, 150);
                }
            }
        }

        function target() {
            this.x = Math.floor(Math.random() * 290);
            this.y = 0;
            this.shot = false;
            this.shotCount = 0;
            this.draw = function() {
                gameArea.context.fillStyle = "grey";
                if (this.shot) {
                    this.shotCount++;
                    gameArea.context.fillRect(this.x, this.y, 4, 4);
                    gameArea.context.fillRect(this.x + 4, this.y + 5, 4, 4);
                    gameArea.context.fillRect(this.x + 12, this.y + 4, 4, 4);
                    gameArea.context.fillRect(this.x + 16, this.y + 4, 4, 4);
                    gameArea.context.fillRect(this.x + 5, this.y + 12, 4, 4);
                    gameArea.context.fillRect(this.x, this.y + 6, 4, 4);
                    gameArea.context.fillRect(this.x + 7, this.y + 8, 4, 4);
                    gameArea.context.fillRect(this.x + 9, this.y + 10, 4, 4);
                } else {
                    gameArea.context.fillRect(this.x, this.y, 20, 20);
                    this.y += 0.3;
                }
            }
        }
    </script>

</body>

</html>